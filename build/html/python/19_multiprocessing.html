<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>19. multiprocessing &mdash; fong alpha documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="20. logging" href="20_logging.html" />
    <link rel="prev" title="18. 异常" href="18_exception.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> fong
            <img src="../_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                alpha
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../cpp/index.html">C/C++</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Python</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_inplace.html">1. in-place 运算</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_all.html">2. __all__ 的使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_is.html">3. is和==</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_decorator.html">4. 装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_iterator.html">5. 迭代器和生成器</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_lambda.html">6. lambda用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_arg.html">7. *args和**kwargs</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_basicType.html">8. 基本数据类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_random.html">9. random</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_normalize.html">10. 归一化</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_dataStruct.html">11. 常用数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_bool.html">12. 逻辑运算与布尔测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="13_name.html">13. 命名规范</a></li>
<li class="toctree-l2"><a class="reference internal" href="14_classFunc.html">14. 类变量与类方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="15_memManage.html">15. 内存管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="16_newInit.html">16. __new__ 和 __init__</a></li>
<li class="toctree-l2"><a class="reference internal" href="17_pip.html">17. pip</a></li>
<li class="toctree-l2"><a class="reference internal" href="18_exception.html">18. 异常</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">19. multiprocessing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#process">19.1. Process 类</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">19.2. 进程池</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">19.3. 进程通信</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#manager">19.3.1. 数据共享：Manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queue">19.3.2. 数据传递：Queue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pipe">19.3.3. 数据传递：Pipe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">19.4. 示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">19.4.1. 创建进程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">19.4.2. 锁</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pool">19.4.3. Pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">19.4.4. Manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">19.4.5. Pipe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">19.5. 参考资料</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="20_logging.html">20. logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="21_pyM.html">21. python -m</a></li>
<li class="toctree-l2"><a class="reference internal" href="22_buildIn.html">22. 内建属性</a></li>
<li class="toctree-l2"><a class="reference internal" href="23_glob.html">23. glob</a></li>
<li class="toctree-l2"><a class="reference internal" href="24_pyLinux.html">24. Python 执行 linux 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="25_bisect.html">25. bisect</a></li>
<li class="toctree-l2"><a class="reference internal" href="26_abc.html">26. abc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux/Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git/index.html">Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../machineLearning/index.html">机器学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deepLearning/index.html">深度学习</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mathematicsAlgorithm/index.html">数理与算法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computerNetwork/index.html">计算机网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../link/index.html">资源链接</a></li>
<li class="toctree-l1"><a class="reference internal" href="../softwares/index.html">实用软件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tech/index.html">Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../else/index.html">其他</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fong</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Python</a> &raquo;</li>
      <li><span class="section-number">19. </span>multiprocessing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/python/19_multiprocessing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multiprocessing">
<h1><span class="section-number">19. </span>multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline"></a></h1>
<p>multiprocessing，基于进程的并行。</p>
<section id="process">
<h2><span class="section-number">19.1. </span>Process 类<a class="headerlink" href="#process" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="o">*</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>进程对象表示在单独进程中运行的活动。</p>
<p>参数说明：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group</span></code> 应该始终是 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，它仅用于兼容 <code class="docutils literal notranslate"><span class="pre">threading.Thread</span></code> 。 <code class="docutils literal notranslate"><span class="pre">target</span></code> 是由 <code class="docutils literal notranslate"><span class="pre">run()</span></code> 方法调用的可调用对象；默认为 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，意味着什么都没有被调用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> 是进程名称。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code> 是目标调用的参数元组；<code class="docutils literal notranslate"><span class="pre">kwargs</span></code> 是目标调用的关键字参数字典。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">daemon</span></code> 是进程的守护标志，一个布尔值，必须在 <code class="docutils literal notranslate"><span class="pre">start()</span></code> 被调用之前设置；初始值继承自创建进程。</p></li>
</ul>
<p>常用方法、属性：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run()</span></code> ：表示进程活动的方法，可以在子类中重载此方法。标准 <code class="docutils literal notranslate"><span class="pre">run()</span></code> 方法调用传递给对象构造函数的可调用对象（ <code class="docutils literal notranslate"><span class="pre">target</span></code> ）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start()</span></code> ：启动进程活动，每个进程对象最多只能调用一次；它会将对象的 <code class="docutils literal notranslate"><span class="pre">run()</span></code> 方法安排在一个单独的进程中调用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">join([timeout])</span></code> ：使主调进程（包含 <code class="docutils literal notranslate"><span class="pre">p.join()</span></code> 语句的进程）阻塞，直至被调用进程 <code class="docutils literal notranslate"><span class="pre">p</span></code> 运行结束或超时（指定 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> ）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_alive()</span></code> ：返回进程是否处于活动状态。粗略地说，从 <code class="docutils literal notranslate"><span class="pre">start()</span></code> 方法返回到子进程终止之前，进程对象仍处于活动状态。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> ：进程的名称，是一个字符串，仅用于识别目的；可以为多个进程指定相同的名称。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pid</span></code> ：进程ID，在生成该进程之前为 <code class="docutils literal notranslate"><span class="pre">None</span></code> 。</p></li>
</ul>
</section>
<section id="id1">
<h2><span class="section-number">19.2. </span>进程池<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Pool</span></code> 类表示一个工作进程池，它具有允许以几种不同方式将任务分配到工作进程的方法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">multiprocessing</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">Pool</span><span class="p">([</span><span class="n">processes</span><span class="p">[,</span> <span class="n">initializer</span><span class="p">[,</span> <span class="n">initargs</span><span class="p">[,</span> <span class="n">maxtasksperchild</span><span class="p">[,</span> <span class="n">context</span><span class="p">]]]]])</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">processes</span></code> 是要使用的工作进程数目。如果 <code class="docutils literal notranslate"><span class="pre">processes</span></code> 为 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，则使用 <code class="docutils literal notranslate"><span class="pre">os.cpu_count()</span></code> 返回的值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">context</span></code> 是用于指定启动工作进程的上下文。通常一个进程池是使用函数 <code class="docutils literal notranslate"><span class="pre">multiprocessing.Pool()</span></code> 或者一个上下文对象的 <code class="docutils literal notranslate"><span class="pre">Pool()</span></code> 方法创建的。</p></li>
</ul>
<p>方法：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">apply(func[,</span> <span class="pre">args[,</span> <span class="pre">kwds]])</span></code> ：对应的子进程是排队执行的，实际非并行（阻塞的，即上一个子进程完成了才能进行下一个子进程；注意是单个子进程执行的，而不是按批执行的）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apply_async(func[,</span> <span class="pre">args[,</span> <span class="pre">kwds[,</span> <span class="pre">callback[,</span> <span class="pre">error_callback]]]])</span></code> ：对应的每个子进程是异步执行的；异步执行指的是一批子进程并行执行，且子进程完成一个，就新开始一个，而不必等待同一批其他进程完成（进程数 &lt; 任务数，后面的任务只能等前面的进程结束才能开始执行）。如果指定了 <code class="docutils literal notranslate"><span class="pre">callback</span></code> , 它必须是一个接受单个参数的可调用对象。当执行成功时， <code class="docutils literal notranslate"><span class="pre">callback</span></code> 会被用于处理执行后的返回结果，否则，调用 <code class="docutils literal notranslate"><span class="pre">error_callback</span></code> 。如果指定了 <code class="docutils literal notranslate"><span class="pre">error_callback</span></code> , 它必须是一个接受单个参数的可调用对象。当目标函数执行失败时，会将抛出的异常对象作为参数传递给 <code class="docutils literal notranslate"><span class="pre">error_callback</span></code> 执行。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">map(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize])</span></code> ：内置 <code class="docutils literal notranslate"><span class="pre">map()</span></code> 函数的并行版本（但它只支持一个 <code class="docutils literal notranslate"><span class="pre">iterable</span></code> 参数，对于多个可迭代对象请参阅 <code class="docutils literal notranslate"><span class="pre">starmap()</span></code> ）。 它会保持阻塞直到所有进程都获得结果。这个方法会将可迭代对象分割为许多块，然后提交给进程池。可以将 <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> 设置为一个正整数从而（近似）指定每个块的大小。注意对于很长的迭代对象，可能消耗很多内存。可以考虑使用 <code class="docutils literal notranslate"><span class="pre">imap()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">imap_unordered()</span></code> 并且显示指定 <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> 以提升效率。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">map_async(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize[,</span> <span class="pre">callback[,</span> <span class="pre">error_callback]]])</span></code> ：<code class="docutils literal notranslate"><span class="pre">map()</span></code> 的异步（非阻塞）版本，返回 MapResult 实例（其具有 <code class="docutils literal notranslate"><span class="pre">get()</span></code> 方法，获取结果组成的 list）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">imap(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize])</span></code> ：<code class="docutils literal notranslate"><span class="pre">map()</span></code> 的迭代器版本，返回迭代器实例。 <code class="docutils literal notranslate"><span class="pre">imap()</span></code> 速度远慢于 <code class="docutils literal notranslate"><span class="pre">map()</span></code> ，但是对内存需求非常小。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">starmap(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize])</span></code> ：子进程活动 <code class="docutils literal notranslate"><span class="pre">func</span></code> 允许包含多个参数，也即 <code class="docutils literal notranslate"><span class="pre">iterable</span></code> 的每个元素也是 <code class="docutils literal notranslate"><span class="pre">iterable</span></code> （其每个元素作为 <code class="docutils literal notranslate"><span class="pre">func</span></code> 的参数），返回结果组成 list。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">starmap_async(func,</span> <span class="pre">iterable[,</span> <span class="pre">chunksize[,</span> <span class="pre">callback[,</span> <span class="pre">error_callback]]])</span></code> ：<code class="docutils literal notranslate"><span class="pre">starmap()</span></code> 的异步（并行）版本，返回 MapResult 实例（其具有 <code class="docutils literal notranslate"><span class="pre">get()</span></code> 方法，获取结果组成的 list）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">close()</span></code> ：关闭进程池，关闭后不能往池中增加新的子进程，然后可以调用 <code class="docutils literal notranslate"><span class="pre">join()</span></code> 函数等待已有子进程执行完毕。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">terminate()</span></code> ：不必等待未完成的任务，立即停止工作进程。当进程池对象被垃圾回收时，会立即调用 <code class="docutils literal notranslate"><span class="pre">terminate()</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">join()</span></code> ：等待进程池中的子进程执行完毕，需在 <code class="docutils literal notranslate"><span class="pre">close()</span></code> 函数后调用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get([timeout])</span></code> ：用于获取执行结果。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wait([timeout])</span></code> ：阻塞，直到返回结果或超时。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>多进程并行执行，它们结束的顺序是不定的，但是最终返回的结果列表顺序是与参数args的顺序一一对应的。</p>
</div>
</section>
<section id="id2">
<h2><span class="section-number">19.3. </span>进程通信<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<section id="manager">
<h3><span class="section-number">19.3.1. </span>数据共享：Manager<a class="headerlink" href="#manager" title="Permalink to this headline"></a></h3>
<p>由 <code class="docutils literal notranslate"><span class="pre">Manager()</span></code> 返回的管理器对象控制一个服务进程，该进程保存 Python 对象并允许其他进程使用代理操作它们。支持类型： list 、 dict 、 Namespace 、 Lock 、 RLock 、 Semaphore 、 BoundedSemaphore 、 Condition 、 Event 、 Barrier 、 Queue 、 Value 和 Array 。</p>
<p>注意：在操作共享对象的元素（子对象）时，除了赋值操作，其他的方法都作用在共享对象的拷贝上，并不会对共享对象生效。</p>
</section>
<section id="queue">
<h3><span class="section-number">19.3.2. </span>数据传递：Queue<a class="headerlink" href="#queue" title="Permalink to this headline"></a></h3>
<p>共享队列:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">([</span><span class="n">maxsize</span><span class="p">])</span>
</pre></div>
</div>
<p>允许多个进程放入、多个进程从队列取出对象。</p>
<p>方法：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qsize()</span></code> ：返回队列的大致长度。由于多线程或者多进程的上下文，这个数字是不可靠的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">empty()</span></code> ：如果队列是空的，返回 True。 由于多线程或多进程的环境，该状态是不可靠的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">full()</span></code> ：如果队列是满的，返回 True ，反之返回 False 。 由于多线程或多进程的环境，该状态是不可靠的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">put(obj[,</span> <span class="pre">block[,</span> <span class="pre">timeout]])</span></code> ：将 <code class="docutils literal notranslate"><span class="pre">obj</span></code> 放入队列。如果可选参数 <code class="docutils literal notranslate"><span class="pre">block</span></code> 是 True（默认值）且 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 是 None（默认值）, 将会阻塞当前进程，直到有空的缓冲槽。如果 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 是正数，将会在阻塞了最多 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 秒之后还是没有可用的缓冲槽时抛出 <code class="docutils literal notranslate"><span class="pre">queue.Full</span></code>  异常。反之（ <code class="docutils literal notranslate"><span class="pre">block</span></code> 是 False 时），仅当有可用缓冲槽时才放入对象，否则抛出 <code class="docutils literal notranslate"><span class="pre">queue.Full</span></code> 异常（在这种情形下 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 参数会被忽略）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get([block[,</span> <span class="pre">timeout]])</span></code> ：从队列中取出并返回对象。如果可选参数 <code class="docutils literal notranslate"><span class="pre">block</span></code> 是 True（默认值）且 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 是 None（默认值）， 将会阻塞当前进程，直到队列中出现可用的对象。如果 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 是正数，将会在阻塞了最多 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 秒之后还是没有可用的对象时抛出 <code class="docutils literal notranslate"><span class="pre">queue.Empty</span></code> 异常。反之（ <code class="docutils literal notranslate"><span class="pre">block</span></code> 是 False 时），仅当有可用对象能够取出时返回，否则抛出 <code class="docutils literal notranslate"><span class="pre">queue.Empty</span></code> 异常（在这种情形下 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 参数会被忽略）。总而言之，在默认参数下，即使队列已经为空也不会抛出异常，会一直阻塞。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">multiprocessing.Queue</span></code> 可能会因为队列中的数据未flush而造成死锁、进程无法退出，建议使用 <code class="docutils literal notranslate"><span class="pre">multiprocessing.Manager().Queue</span></code> 。</p>
</div>
</section>
<section id="pipe">
<h3><span class="section-number">19.3.3. </span>数据传递：Pipe<a class="headerlink" href="#pipe" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">([</span><span class="n">duplex</span><span class="p">])</span>
</pre></div>
</div>
<p>返回一对 Connection 对象  <code class="docutils literal notranslate"><span class="pre">(conn1,</span> <span class="pre">conn2)</span></code> ， 分别表示管道的两端。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">duplex</span></code> 被置为 True（默认值），那么该管道是双向的。如果 <code class="docutils literal notranslate"><span class="pre">duplex</span></code> 被置为 False ，那么该管道是单向的，即 <code class="docutils literal notranslate"><span class="pre">conn1</span></code> 只能用于接收消息，而 <code class="docutils literal notranslate"><span class="pre">conn2</span></code> 仅能用于发送消息。</p>
<p>Connection 对象的方法：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">send(obj)</span></code> ：发送数据。只能发送可 pickle 的数据</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recv()</span></code> ：读取管道中接收到的数据。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">close()</span></code> ：关闭连接对象。当连接对象被垃圾回收时会自动调用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">poll([timeout])</span></code> ：判断管道对象是否有收到数据待读取。</p></li>
</ul>
</section>
</section>
<section id="id3">
<h2><span class="section-number">19.4. </span>示例<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<section id="id4">
<h3><span class="section-number">19.4.1. </span>创建进程<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
<span class="linenos"> 5</span>    <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="linenos"> 6</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;module name:&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parent process:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getppid</span><span class="p">())</span>
<span class="linenos"> 8</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;process id:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="linenos">11</span>    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;function f&#39;</span><span class="p">)</span>
<span class="linenos">12</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">15</span>    <span class="n">info</span><span class="p">(</span><span class="s1">&#39;main line&#39;</span><span class="p">)</span>
<span class="linenos">16</span>    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;bob&#39;</span><span class="p">,))</span>
<span class="linenos">17</span>    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos">18</span>    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="c1">## if __name__ == &#39;__main__&#39; 是必需的</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3><span class="section-number">19.4.2. </span>锁<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<p>使用 Lock 同步，在一个任务输出完成之后，再允许另一个任务输出，可以避免多个任务同时向终端输出。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Lock</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="linenos"> 4</span>    <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="linenos"> 5</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 6</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos"> 8</span>        <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">11</span>    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
<span class="linenos">12</span>
<span class="linenos">13</span>    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="linenos">14</span>        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="pool">
<h3><span class="section-number">19.4.3. </span>Pool<a class="headerlink" href="#pool" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">):</span> <span class="c1">## map方法只允许1个参数</span>
<span class="linenos"> 2</span>    <span class="k">return</span> <span class="n">a</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos"> 5</span>    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span>
<span class="linenos"> 6</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">]]</span>
<span class="linenos"> 7</span>    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 8</span>    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="c1">## starmap方法允许多个参数</span>
<span class="linenos">2</span>    <span class="k">return</span> <span class="n">a</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">5</span>    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span>
<span class="linenos">6</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">((</span><span class="n">a0</span><span class="p">,</span> <span class="n">b0</span><span class="p">),</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">),</span> <span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="linenos">7</span>    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">8</span>    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="linenos"> 5</span>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos"> 6</span>    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="k">return</span> <span class="n">t</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="linenos">10</span>    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">11</span>    <span class="c1">## 阻塞</span>
<span class="linenos">12</span>    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos">13</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===&quot;</span><span class="p">)</span>
<span class="linenos">14</span>    <span class="c1">## 非阻塞</span>
<span class="linenos">15</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="linenos">16</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;here&quot;</span><span class="p">)</span>
<span class="linenos">17</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;more&quot;</span><span class="p">)</span>
<span class="linenos">18</span>    <span class="c1">## 人为阻塞，直到获得所有的结果</span>
<span class="linenos">19</span>    <span class="n">result</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="linenos">20</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
<span class="linenos">21</span>    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">22</span>    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="linenos">23</span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</pre></div>
</div>
<p>结果是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">0.1</span>
<span class="mf">0.1</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">5</span>
<span class="mf">0.1</span>
<span class="mf">0.1</span>
<span class="o">===</span>
<span class="n">here</span>
<span class="n">more</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">5</span>
<span class="n">end</span>
<span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>可以看出： <code class="docutils literal notranslate"><span class="pre">map</span></code> 是阻塞的，直到所有任务都结束； <code class="docutils literal notranslate"><span class="pre">map_async</span></code> 是非阻塞的，中间可以插入其他结果。</p>
</section>
<section id="id6">
<h3><span class="section-number">19.4.4. </span>Manager<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
<span class="linenos"> 5</span>    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Python&#39;</span>
<span class="linenos"> 6</span>    <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Java&quot;</span>
<span class="linenos"> 7</span>    <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
<span class="linenos"> 8</span>    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> <span class="c1"># 获得当前的进程号</span>
<span class="linenos"> 9</span>    <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">13</span>    <span class="k">with</span> <span class="n">Manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<span class="linenos">15</span>        <span class="n">l</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="linenos">16</span>        <span class="n">p_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">17</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<span class="linenos">18</span>            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
<span class="linenos">19</span>            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos">20</span>            <span class="n">p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="linenos">21</span>        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">p_list</span><span class="p">:</span>
<span class="linenos">22</span>            <span class="n">res</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="linenos">23</span>        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">14168</span><span class="p">]</span>
<span class="p">[</span><span class="mi">14168</span><span class="p">,</span> <span class="mi">14108</span><span class="p">]</span>
<span class="p">[</span><span class="mi">14168</span><span class="p">,</span> <span class="mi">14108</span><span class="p">,</span> <span class="mi">5412</span><span class="p">]</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Python&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Java&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;5412&#39;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3><span class="section-number">19.4.5. </span>Pipe<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span><span class="p">,</span> <span class="n">current_process</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="kn">import</span> <span class="n">wait</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="sd">&#39;&#39;&#39;</span>
<span class="linenos"> 6</span><span class="sd">wait(object_list) ：</span>
<span class="linenos"> 7</span><span class="sd">可以一次轮询多个连接对象，一直等待直到 object_list 中某个对象处于就绪状态。</span>
<span class="linenos"> 8</span><span class="sd">返回 object_list 中处于就绪状态的对象。</span>
<span class="linenos"> 9</span><span class="sd">当一个连接或者套接字对象拥有有效的数据可被读取的时候，或者另一端关闭后，这个对象就处于就绪状态。</span>
<span class="linenos">10</span><span class="sd">&#39;&#39;&#39;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
<span class="linenos">13</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<span class="linenos">14</span>        <span class="n">w</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
<span class="linenos">15</span>    <span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">18</span>    <span class="n">readers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">19</span>
<span class="linenos">20</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="linenos">21</span>        <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">(</span><span class="n">duplex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="n">readers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="linenos">23</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">foo</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,))</span>
<span class="linenos">24</span>        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="linenos">25</span>        <span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">26</span>
<span class="linenos">27</span>    <span class="k">while</span> <span class="n">readers</span><span class="p">:</span>
<span class="linenos">28</span>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">wait</span><span class="p">(</span><span class="n">readers</span><span class="p">):</span>
<span class="linenos">29</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">30</span>                <span class="n">msg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="linenos">31</span>            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
<span class="linenos">32</span>                <span class="n">readers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="linenos">33</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">34</span>                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Process-1&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Process-1&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Process-1&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Process-1&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Process-1&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Process-2&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Process-2&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Process-2&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Process-2&#39;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Process-2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在多进程任务中，如果每个进程都要从一个共享队列中读数据，而这个队列需要存储的列表很长，
把数据完整地填充（put）到队列中需要花费很长时间，在这种情况下，不要等到队列中填充完了所有的数据才启动进程，
而是先启动（start）进程任务，再填充队列，直到进程结束（join）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">fill_queue</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>
</div>
<p>这样一来，总体上看，一边填充队列，任务一边执行，效率大大提高。但是，进程读队列的时候队列可能为空，
这时候需要处理异常，读到空的次数达到一定阈值的时候任务结束:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## python3</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="c1">## process task</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">empty_cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">empty_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">empty_cnt</span> <span class="o">&gt;</span> <span class="n">th_cnt</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="id8">
<h2><span class="section-number">19.5. </span>参考资料<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>multiprocessing — Process-based parallelism</p></li>
</ol>
<blockquote>
<div><p><a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">https://docs.python.org/3/library/multiprocessing.html</a></p>
<p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/multiprocessing.html">https://docs.python.org/zh-cn/3/library/multiprocessing.html</a></p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>python并行计算（上）：multiprocessing、multiprocess模块</p></li>
</ol>
<blockquote>
<div><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/46798399">https://zhuanlan.zhihu.com/p/46798399</a></p>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="18_exception.html" class="btn btn-neutral float-left" title="18. 异常" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="20_logging.html" class="btn btn-neutral float-right" title="20. logging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, fong.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<script type="text/javascript">
    $(document).ready(function() {
     $(".toggle > *").hide();
     $(".toggle .header").show();
     $(".toggle .header").click(function() {
      $(this).parent().children().not(".header").toggle(400);
      $(this).parent().children(".header").toggleClass("open");
     })
    });
</script>


</body>
</html>